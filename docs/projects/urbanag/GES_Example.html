<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.330">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GES: Greenhouse Energy Simulation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="GES_Example_files/libs/clipboard/clipboard.min.js"></script>
<script src="GES_Example_files/libs/quarto-html/quarto.js"></script>
<script src="GES_Example_files/libs/quarto-html/popper.min.js"></script>
<script src="GES_Example_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="GES_Example_files/libs/quarto-html/anchor.min.js"></script>
<link href="GES_Example_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="GES_Example_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="GES_Example_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="GES_Example_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="GES_Example_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">GES: Greenhouse Energy Simulation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This python3 code simulates heat, mass and CO<span class="math inline">\(_2\)</span> exchange in an unheated, ventilated single-zone greenhouse for a simple test case. The heat transfer processes simulated include convection, conduction and radiation, together with plant transpiration for simulation of heat and mass exchange due to evaporation of water from the leaf surface. Simple models of photosynthesis and crop growth for tomatoes are included in order to simulate CO<span class="math inline">\(_2\)</span> exchange. The model is based on the GDGCM (Pieters, J. and Deltour, J., ‘The Gembloux Dynamic Greenhouse Climate Model - GDGCM’, 2000) and on the thesis by Vanthoor (Vanthoor, B.H.,‘A model-based greenhouse design method’, PhD Thesis, Wageningen University, 2011).</p>
<p>The original code was written in MATLAB and can be found on GitHub at https://github.com/EECi/GES.</p>
<section id="sample-data" class="level1">
<h1>Sample Data</h1>
<p>The example given is a single zone unheated greenhouse, dimensions 10 x 25 x 5m with no artificial lighting or supplemental CO<span class="math inline">\(_2\)</span>, as illustrated below.</p>
<p style="text-align:center;">
<img src="Greenhouse.png" alt="Greenhouse geometry" width="100%" height="100%" title="Greenhouse geometry">
</p>
<p>The heat, mass and CO<span class="math inline">\(_2\)</span> exchanges are modelled as indicated.</p>
<p style="text-align:center;">
<img src="Balance.png" alt="Heat and mass balance" width="60%" height="60%" title="Heat and mass balance schematic">
</p>
<p>The files required with this notebook include:</p>
<ul>
<li><code>functions.py</code> contains generic functions for convection, radiation and conduction calculations, climate data interpolation and calculation of relative humidity</li>
<li><code>parameters.py</code> contains parameter values for fundamental constants, greenhouse construction and operation and plant geometry and growth.</li>
<li><code>SampleWeather.csv</code> Hourly input weather data, in the format ’Hour, Ambient Temperature (<span class="math inline">\(^o\)</span>C), Sky Temperature (<span class="math inline">\(^o\)</span>C), Windspeed (m/s), Relative Humidity (%), Direct Solar Radiation (order NE wall, NE Roof, SE Wall, SE Roof, SW Wall, SW Roof, NW Wall, NW Roof) (W/m<span class="math inline">\(^2\)</span>), Diffuse Solar Radiation (order as for Direct)(W/m<span class="math inline">\(^2\)</span>)</li>
</ul>
</section>
<section id="simulation" class="level1">
<h1>Simulation</h1>
<section id="initialise" class="level2">
<h2 class="anchored" data-anchor-id="initialise">Initialise</h2>
<p>The first steps are to import dependencies and to define initial conditions for all the dependent variables whose evolution will be calculated from the differential equations.</p>
<p>These include:</p>
<ul>
<li>temperatures of the cover, internal air, vegetation, growing medium (mat), tray, floor and soil layers (4 layers specified here),</li>
<li>24 hour mean vegetation temperature and vegetation temperature sum, used in the plant growth calculations,</li>
<li>density of air moisture and CO<span class="math inline">\(_2\)</span> in the greenhouse,</li>
<li>mass of carbohydrate present in the stem, leaf, fruit and buffers, and relative growth rate coefficients.</li>
</ul>
<p>from <code>functions.py</code> the routines for calculating heat exchange due to convection, conduction and radiation are imported, together with a routine for calculating the saturated air moisture content as a function of temperature (used for converting relative humidity values to air moisture content)</p>
<p><strong>Import dependencies</strong></p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functions <span class="im">import</span> convection, radiation, conduction, sat_conc</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.integrate <span class="im">import</span> solve_ivp</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.integrate <span class="im">import</span> odeint</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.interpolate <span class="im">import</span> interp1d</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> parameters <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Specify initial conditions</strong></p>
<div class="cell" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial conditions</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Temperatures</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>T_c_0 <span class="op">=</span> <span class="fl">20.</span> <span class="op">+</span> T_k <span class="co"># Cover temperature [K]</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>T_i_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Internal air temperature [K]</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>T_v_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Vegetation temperature [K]</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>T_m_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Growing medium temperature [K]</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>T_p_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Tray temperature [K]</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>T_f_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Floor temperature [K]</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>T_s1_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Temperature of soil layer 1 [K]</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>T_s2_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Temperature of soil layer 2 [K]</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>T_s3_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k <span class="co"># Temperature of soil layer 3 [K]</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>T_s4_0 <span class="op">=</span> <span class="fl">11.</span> <span class="op">+</span> T_k <span class="co"># Temperature of soil layer 4 [K]</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>T_vmean_0 <span class="op">=</span> <span class="fl">12.</span> <span class="op">+</span> T_k<span class="op">;</span> <span class="co"># 24 hour mean vegetation temperature [K]</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>T_vsum_0 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co"># Vegetation temperature sum [degC]                       </span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>C_w_0 <span class="op">=</span> <span class="fl">0.0085</span> <span class="co"># Density of water vapour [kg/m^3]</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>C_c_0 <span class="op">=</span> <span class="fl">7.5869e-4</span> <span class="co"># CO_2 density</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">#                     </span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>C_buf_0 <span class="op">=</span> <span class="fl">0.01</span> <span class="co"># Mass of carbohydrate in buffer per unit per unit area of cultivated floor [kg/m^2]</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>C_fruit_0 <span class="op">=</span> <span class="fl">0.001</span> <span class="co"># Mass of carbohydrate in fruit per unit per unit area of cultivated floor [kg/m^2]</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>C_leaf_0 <span class="op">=</span> <span class="fl">0.01</span> <span class="co"># Mass of carbohydrate in leaves per unit per unit area of cultivated floor [kg/m^2]</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>C_stem_0 <span class="op">=</span> <span class="fl">0.01</span> <span class="co"># Mass of carbohydrate in stem per unit per unit area of cultivated floor [kg/m^2]</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>R_fruit_0 <span class="op">=</span> <span class="fl">0.</span> <span class="co"># Relative growth rate of fruit averaged over 5 days [1/s]</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>R_leaf_0 <span class="op">=</span> <span class="fl">0.</span> <span class="co"># Relative growth rate of leaf averaged over 5 days [1/s]</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>R_stem_0 <span class="op">=</span> <span class="fl">0.</span> <span class="co"># Relative growth rate of stem averaged over 5 days [1/s]</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> [T_c_0, T_i_0, T_v_0, T_m_0, T_p_0, T_f_0, T_s1_0, T_s2_0, T_s3_0, T_s4_0, T_vmean_0, T_vsum_0, C_w_0, C_c_0, C_buf_0, C_fruit_0, C_leaf_0, C_stem_0, R_fruit_0, R_leaf_0, R_stem_0]</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>daynum <span class="op">=</span> [<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="interpolate-weather-data" class="level2">
<h2 class="anchored" data-anchor-id="interpolate-weather-data">Interpolate weather data</h2>
<p>The file ‘SampleWeather.csv’ containing hourly weather data is imported and interpolated to the time step of interest, here set to 60s.</p>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>climdat <span class="op">=</span> np.genfromtxt(<span class="st">'SampleWeather.csv'</span>, delimiter<span class="op">=</span><span class="st">','</span>) <span class="co"># Hourly data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>deltaT <span class="op">=</span> <span class="dv">60</span> <span class="co"># s</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>l<span class="op">=</span><span class="bu">len</span>(climdat)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>mult<span class="op">=</span>np.linspace(<span class="dv">1</span>,l,<span class="bu">int</span>((l<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">3600</span><span class="op">/</span>deltaT))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>y_interp <span class="op">=</span> interp1d(climdat[:,<span class="dv">0</span>], climdat[:,<span class="dv">1</span>:<span class="dv">21</span>],axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>climate <span class="op">=</span> y_interp(mult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="define-ode-model" class="level2">
<h2 class="anchored" data-anchor-id="define-ode-model">Define ODE model</h2>
<p>The model consists of a set of Ordinary Differential Equations (ODEs) for calculation of temperature, moisture content, CO<span class="math inline">\(_2\)</span> concentration and plant growth evolution.</p>
<p>The ODEs include the following heat and mass transfer components:</p>
<ul>
<li>convective heat transfer between the external air and the greenhouse cover,</li>
<li>convective heat transfer and partial mass transfer between the internal air and surfaces of the plants, cover, floor, mat and tray,</li>
<li>radiative heat transfer between all surfaces and between the cover and sky,</li>
<li>heat conduction through the floor and from the mat to the tray,</li>
<li>heat and mass transfer due to ventilation,</li>
<li>heat input due to incident solar radiation, and</li>
<li>heat and mass transfer due to plant transpiration.</li>
</ul>
<p>The photosynthesis model generates rates for photosynthesis and photorespiration. These are used in conjunction with flow rates for carbohydrate from a buffer to the plant organs to calculate crop growth in terms of growth of the leaves, stem and fruit. It is assumed that once growth has reached a certain level the leaves are harvested to maintain a constant value for the ratio of leaf area to planted area (leaf area index or LAI).</p>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> day(t):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Day</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    day_new <span class="op">=</span> np.ceil(t<span class="op">/</span><span class="dv">86400</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(day_new)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model(t,z):</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Values being calculated</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    T_c <span class="op">=</span> z[<span class="dv">0</span>]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    T_i <span class="op">=</span> z[<span class="dv">1</span>]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    T_v <span class="op">=</span> z[<span class="dv">2</span>]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    T_m <span class="op">=</span> z[<span class="dv">3</span>]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    T_p <span class="op">=</span> z[<span class="dv">4</span>]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    T_f <span class="op">=</span> z[<span class="dv">5</span>]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    T_s1 <span class="op">=</span> z[<span class="dv">6</span>]</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    T_s2 <span class="op">=</span> z[<span class="dv">7</span>]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    T_s3 <span class="op">=</span> z[<span class="dv">8</span>]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    T_s4 <span class="op">=</span> z[<span class="dv">9</span>]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    T_vmean <span class="op">=</span> z[<span class="dv">10</span>]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    T_vsum <span class="op">=</span> z[<span class="dv">11</span>]</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    C_w <span class="op">=</span> z[<span class="dv">12</span>]</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    C_c <span class="op">=</span> z[<span class="dv">13</span>]</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    C_buf <span class="op">=</span> z[<span class="dv">14</span>]</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    C_fruit <span class="op">=</span> z[<span class="dv">15</span>]</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    C_leaf <span class="op">=</span> z[<span class="dv">16</span>]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    C_stem <span class="op">=</span> z[<span class="dv">17</span>]</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    R_fruit <span class="op">=</span> z[<span class="dv">18</span>]</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    R_leaf <span class="op">=</span> z[<span class="dv">19</span>]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    R_stem <span class="op">=</span> z[<span class="dv">20</span>]</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># External weather and dependent internal parameter values</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">int</span>(np.ceil(t<span class="op">/</span>deltaT)) <span class="co"># count</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    T_ext <span class="op">=</span> climate[n, <span class="dv">0</span>] <span class="op">+</span> T_k <span class="co"># External air temperature (K)</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    T_sk <span class="op">=</span> climate[n, <span class="dv">1</span>] <span class="op">+</span> T_k <span class="co"># External sky temperature (K)</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    wind_speed <span class="op">=</span> climate[n, <span class="dv">2</span>] <span class="co"># External wind speed (m/s)</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    RH_e <span class="op">=</span> climate[n, <span class="dv">3</span>]<span class="op">/</span><span class="dv">100</span> <span class="co"># External relative humidity</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    Cw_ext <span class="op">=</span> RH_e <span class="op">*</span> sat_conc(T_ext) <span class="co"># External air moisture content</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    p_w <span class="op">=</span> C_w<span class="op">*</span>R<span class="op">*</span>T_i<span class="op">/</span>M_w <span class="co"># Partial pressure of water [Pa]</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    rho_i <span class="op">=</span> ((atm <span class="op">-</span> p_w)<span class="op">*</span>M_a <span class="op">+</span> p_w<span class="op">*</span>M_w)<span class="op">/</span>(R<span class="op">*</span>T_i) <span class="co"># Internal density of air [kg/m^3]   </span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    LAI <span class="op">=</span> SLA<span class="op">*</span>C_leaf <span class="co"># Leaf area index</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    C_ce <span class="op">=</span> <span class="fl">4.0e-4</span><span class="op">*</span>M_c<span class="op">*</span>atm<span class="op">/</span>(R<span class="op">*</span>T_ext) <span class="co"># External carbon dioxide concentration [kg/m^3]</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    C_c_ppm <span class="op">=</span> C_c<span class="op">*</span>R<span class="op">*</span>T_i<span class="op">/</span>(M_c<span class="op">*</span>atm)<span class="op">*</span><span class="fl">1.e6</span> <span class="co"># External carbon dioxide concentration [ppm]</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    daynum.append(day(t)) <span class="co"># Day number</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Option for printing progress of run in days - uncomment out if needed</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">#if daynum[(len(daynum)-1)] &gt; daynum[(len(daynum)-2)]:</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">#    print(daynum[len(daynum)-1])</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    hour <span class="op">=</span> np.floor(t<span class="op">/</span><span class="dv">3600</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Option for printing progress in hours - uncomment if needed</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(hour)</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    day_hour<span class="op">=</span>(hour<span class="op">/</span><span class="dv">24</span><span class="op">-</span>np.floor(hour<span class="op">/</span><span class="dv">24</span>))<span class="op">*</span><span class="dv">24</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Lights</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    L_on <span class="op">=</span> <span class="dv">0</span> <span class="co"># No additional lighting included</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    AL_on <span class="op">=</span> <span class="dv">0</span> <span class="co"># No ambient lighting included</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Convection</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convection external air -&gt; cover</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    (QV_e_c, QP_e_c, Nu_e_c ) <span class="op">=</span> convection(d_c, A_c, T_ext, T_c, wind_speed, rho_i, c_i, C_w)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    QP_e_c <span class="op">=</span> <span class="dv">0</span> <span class="co"># Assumed no external condensation/evaporation</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convection internal air -&gt; cover</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    (QV_i_c, QP_i_c, Nu_i_c) <span class="op">=</span> convection(d_c, A_c, T_i, T_c, ias, rho_i, c_i, C_w)</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    QP_i_c <span class="op">=</span> <span class="bu">max</span>(QP_i_c,<span class="dv">0</span>) <span class="co"># assumed no evaporation from the cover, only condensation</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convection internal air -&gt; floor</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    (QV_i_f, QP_i_f, Nu_i_f) <span class="op">=</span> convection(d_f, A_f, T_i, T_f, ias, rho_i, c_i, C_w)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    QP_i_f <span class="op">=</span> <span class="bu">max</span>(QP_i_f,<span class="dv">0</span>) <span class="co"># assumed no evaporation from the floor, only condensation</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convection internal air -&gt; vegetation</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    A_v_exp <span class="op">=</span> LAI<span class="op">*</span>A_v</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    (QV_i_v, QP_i_v, Nu_i_v) <span class="op">=</span> convection(d_v, A_v_exp, T_i, T_v, ias, rho_i, c_i, C_w)</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    QP_i_v <span class="op">=</span> <span class="dv">0</span> <span class="co"># No condensation/evaporation - transpiration considered separately</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    HV <span class="op">=</span> Nu_i_v<span class="op">*</span>lam<span class="op">/</span>d_v</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convection internal air -&gt; mat</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    A_m_wool <span class="op">=</span> <span class="fl">0.75</span><span class="op">*</span>A_m <span class="co"># Area of mat exposed</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    A_m_water <span class="op">=</span> <span class="fl">0.25</span><span class="op">*</span>A_m <span class="co"># assumed 25% saturated</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    (QV_i_m, QP_i_m, Nu_i_m) <span class="op">=</span> convection(d_m, A_m_wool, T_i, T_m, ias, rho_i, c_i, C_w)</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    QP_i_m <span class="op">=</span> A_m_water<span class="op">/</span>A_m_wool <span class="op">*</span> QP_i_m <span class="co"># Factored down</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convection internal air -&gt; tray</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    (QV_i_p, QP_i_p, Nu_i_p) <span class="op">=</span> convection(d_p, A_p, T_i, T_p, ias, rho_i, c_i, C_w)</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    QP_i_p <span class="op">=</span> <span class="dv">0</span> <span class="co"># Assumed no condensation/evaporation from tray</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Far-IR Radiation</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    A_vvf<span class="op">=</span><span class="bu">min</span>(LAI<span class="op">*</span>p_v<span class="op">*</span>A_f,p_v<span class="op">*</span>A_f)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    F_c_v <span class="op">=</span> <span class="bu">min</span>((<span class="dv">1</span><span class="op">-</span>F_c_f)<span class="op">*</span>LAI,(<span class="dv">1</span><span class="op">-</span>F_c_f)) <span class="co"># Cover to vegetation</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    F_c_m <span class="op">=</span> <span class="bu">max</span>((<span class="dv">1</span><span class="op">-</span>F_c_f)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>LAI),<span class="dv">0</span>) <span class="co"># Cover to mat</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    F_m_c <span class="op">=</span> <span class="bu">max</span>((<span class="dv">1</span><span class="op">-</span>LAI),<span class="fl">0.0</span>) <span class="co"># Mat to cover</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    F_m_v <span class="op">=</span> <span class="dv">1</span><span class="op">-</span>F_m_c <span class="co"># Mat to vegetation</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cover to sky</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    QR_c_sk <span class="op">=</span> radiation(eps_ce, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, A_c, T_c, T_sk)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation cover to floor</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    QR_c_f <span class="op">=</span> radiation(eps_ci, eps_s, rho_ci, rho_s, F_c_f, F_f_c, A_c_roof, T_c, T_f)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation cover to vegetation</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    QR_c_v <span class="op">=</span> radiation(eps_ci, eps_v, rho_ci, rho_v, F_c_v, F_v_c, A_c_roof, T_c, T_v)</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation cover to mat</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    QR_c_m <span class="op">=</span> radiation(eps_ci, eps_m, rho_ci, rho_m, F_c_m, F_m_c, A_c_roof, T_c, T_m)</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation vegetation to cover</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>    QR_v_c <span class="op">=</span> radiation(eps_v, eps_ci, rho_v, rho_ci, F_v_c, F_c_v, A_vvf, T_v, T_c)</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation vegetation to mat</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>    QR_v_m <span class="op">=</span> radiation(eps_v, eps_m, rho_v, rho_m, F_v_m, F_m_v, A_vvf, T_v, T_m)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation vegetation to tray</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    QR_v_p <span class="op">=</span> radiation(eps_v, eps_p, rho_v, rho_p, F_v_p, F_p_v, A_vvf, T_v, T_p)</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation mat to cover</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>    QR_m_c <span class="op">=</span> radiation(eps_m, eps_ci, rho_m, rho_ci, F_m_c, F_c_m, A_m, T_m, T_c)</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation mat to vegetation</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    QR_m_v <span class="op">=</span> radiation(eps_m, eps_v, rho_m, rho_v, F_m_v, F_v_m, A_m, T_m, T_v)</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation mat to tray</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>    QR_m_p <span class="op">=</span> radiation(eps_m, eps_p, rho_m, rho_p, F_m_p, F_p_m, A_m, T_m, T_p)</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation tray to vegetation</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>    QR_p_v <span class="op">=</span> radiation(eps_p, eps_v, rho_p, rho_v, F_p_v, F_v_p, A_p, T_p, T_v)</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation tray to mat</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>    QR_p_m <span class="op">=</span> radiation(eps_p, eps_m, rho_p, rho_m, F_p_m, F_m_p, A_p, T_p, T_m)</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation tray to floor</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    QR_p_f <span class="op">=</span> radiation(eps_p, eps_s, rho_p, rho_s, F_p_f, F_f_p, A_p, T_p, T_f)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation floor to cover</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    QR_f_c <span class="op">=</span> radiation(eps_s, eps_ci, rho_s, rho_ci, F_f_c, F_c_f, A_f, T_f, T_c)</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation floor to tray</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>    QR_f_p <span class="op">=</span> radiation(eps_s, eps_p, rho_s, rho_p, F_f_p, F_p_f, A_f, T_f, T_p)</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Conduction</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Conduction through floor</span></span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>    QD_sf1 <span class="op">=</span> conduction(A_f, lam_s[<span class="dv">0</span>], l_s[<span class="dv">0</span>], T_f, T_s1)</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>    QD_s12 <span class="op">=</span> conduction(A_f, lam_s[<span class="dv">1</span>], l_s[<span class="dv">1</span>], T_s1, T_s2)</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>    QD_s23 <span class="op">=</span> conduction(A_f, lam_s[<span class="dv">2</span>], l_s[<span class="dv">2</span>], T_s2, T_s3)</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>    QD_s34 <span class="op">=</span> conduction(A_f, lam_s[<span class="dv">3</span>], l_s[<span class="dv">3</span>], T_s3, T_s4)</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>    QD_s45 <span class="op">=</span> conduction(A_f, lam_s[<span class="dv">4</span>], l_s[<span class="dv">4</span>], T_s4, T_ss)</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Conduction mat to tray</span></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>    QD_m_p <span class="op">=</span> (A_m<span class="op">*</span>lam_p<span class="op">/</span>l_m)<span class="op">*</span>(T_m<span class="op">-</span>T_p)</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ventilation</span></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Leakage (equations for orifice flow from Awbi, Ventilation of Buildings, Chapter 3)</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>    wind_speed_H <span class="op">=</span> wind_speed<span class="op">*</span>c<span class="op">*</span>H<span class="op">**</span>a <span class="co"># Wind speed at height H</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>    wind_pressure <span class="op">=</span> Cp<span class="op">*</span><span class="fl">0.5</span><span class="op">*</span>rho_i<span class="op">*</span>wind_speed_H<span class="op">**</span><span class="dv">2</span> <span class="co"># Equals DeltaP for wind pressure</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>    stack_pressure_diff <span class="op">=</span> rho_i<span class="op">*</span>g<span class="op">*</span>H<span class="op">*</span>(T_i <span class="op">-</span> T_ext)<span class="op">/</span>T_i <span class="co"># DeltaP for stack pressure</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>    Qw <span class="op">=</span> Cd<span class="op">*</span>crack_area<span class="op">*</span>(<span class="dv">2</span><span class="op">*</span>wind_pressure<span class="op">/</span>rho_i)<span class="op">**</span><span class="fl">0.5</span> <span class="co"># Flow rate due to wind pressure</span></span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>    Qs <span class="op">=</span> Cd<span class="op">*</span>crack_area<span class="op">*</span>(<span class="dv">2</span><span class="op">*</span><span class="bu">abs</span>(stack_pressure_diff)<span class="op">/</span>rho_i)<span class="op">**</span><span class="fl">0.5</span> <span class="co"># Flow rate due to stack pressure</span></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>    Qt <span class="op">=</span> (Qw<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> Qs<span class="op">**</span><span class="dv">2</span>)<span class="op">**</span><span class="fl">0.5</span> <span class="co"># Total flow rate</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>    total_air_flow <span class="op">=</span> Qt<span class="op">*</span>crack_length_total<span class="op">/</span>crack_length </span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>    R_a_min <span class="op">=</span> total_air_flow<span class="op">/</span>V </span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Ventilation</span></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>    DeltaT_vent <span class="op">=</span> T_i <span class="op">-</span> T_sp_vent</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>    comp_dtv_low <span class="op">=</span> DeltaT_vent <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> DeltaT_vent <span class="op">&lt;</span> <span class="dv">4</span></span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>    comp_dtv_high <span class="op">=</span> DeltaT_vent <span class="op">&gt;=</span> <span class="dv">4</span></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>    R_a <span class="op">=</span> R_a_min <span class="op">+</span> comp_dtv_low<span class="op">*</span>(R_a_max <span class="op">-</span> R_a_min)<span class="op">/</span><span class="dv">4</span><span class="op">*</span>DeltaT_vent <span class="op">+</span> comp_dtv_high<span class="op">*</span>(R_a_max<span class="op">-</span>R_a_min)</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>    QV_i_e <span class="op">=</span> R_a<span class="op">*</span>V<span class="op">*</span>rho_i<span class="op">*</span>c_i<span class="op">*</span>(T_i <span class="op">-</span> T_ext) <span class="co"># Internal air to outside air [J/s]</span></span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>    QP_i_e <span class="op">=</span> R_a<span class="op">*</span>V<span class="op">*</span>H_fg<span class="op">*</span>(C_w <span class="op">-</span> Cw_ext) <span class="co"># Latent heat loss due to leakiness</span></span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>    MW_i_e <span class="op">=</span> R_a<span class="op">*</span>(C_w <span class="op">-</span> Cw_ext)</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>    <span class="co">##      Solar radiation</span></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We first define the solar elevation angle that determines that absorption of solar radiation. Notation: r is direct radiation, f is diffuse radiation, whilst VIS and NIR stand for visible and near infra-red respectively.</span></span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>    gamma <span class="op">=</span> np.deg2rad(<span class="fl">360.</span><span class="op">*</span>(day(t) <span class="op">-</span>  <span class="fl">80.</span>)<span class="op">/</span><span class="fl">365.</span>) <span class="co"># Year angle [rad] --- day counts from January 1st</span></span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>    eqn_time <span class="op">=</span> <span class="op">-</span><span class="fl">7.13</span><span class="op">*</span>np.cos(gamma) <span class="op">-</span> <span class="fl">1.84</span><span class="op">*</span>np.sin(gamma) <span class="op">-</span> <span class="fl">0.69</span><span class="op">*</span>np.cos(<span class="fl">2.</span><span class="op">*</span> gamma) <span class="op">+</span> <span class="fl">9.92</span><span class="op">*</span>np.sin(<span class="fl">2.</span><span class="op">*</span>gamma) <span class="co"># Equation of time [min]</span></span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>    az <span class="op">=</span> np.deg2rad(<span class="fl">360.</span><span class="op">*</span>((t<span class="op">/</span>(<span class="fl">3600.</span>)<span class="op">%</span><span class="fl">24.</span>) <span class="op">+</span> eqn_time<span class="op">/</span><span class="fl">60.</span> <span class="op">-</span> <span class="fl">12.</span>)<span class="op">/</span><span class="fl">24.</span>) <span class="co"># Azimuth [rad]</span></span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> np.deg2rad(<span class="fl">0.38</span> <span class="op">-</span> <span class="fl">0.77</span><span class="op">*</span>np.cos(gamma) <span class="op">+</span> <span class="fl">23.27</span><span class="op">*</span>np.cos(gamma)) <span class="co"># Declination angle [rad]</span></span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>    lat <span class="op">=</span> np.deg2rad(latitude)</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>    angler <span class="op">=</span> np.arcsin(np.sin(lat)<span class="op">*</span>np.sin(delta) <span class="op">+</span> np.cos(lat)<span class="op">*</span>np.cos(delta)<span class="op">*</span>np.cos(az)) <span class="co"># Angle of elevation [rad]</span></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>    angle <span class="op">=</span> np.rad2deg(angler)</span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Radiation from artifical lighting</span></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>    QS_al_NIR <span class="op">=</span> <span class="fl">0.</span> <span class="co"># no artificial lighting</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>    QS_al_VIS <span class="op">=</span> <span class="fl">0.</span> </span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solar radiation incident on the cover</span></span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>    QS_tot_rNIR <span class="op">=</span> <span class="fl">0.5</span><span class="op">*</span>SurfaceArea<span class="op">@</span>climate[n, <span class="dv">4</span>:<span class="dv">12</span>] <span class="co"># Direct </span></span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>    QS_tot_rVIS <span class="op">=</span> <span class="fl">0.5</span><span class="op">*</span>SurfaceArea<span class="op">@</span>climate[n, <span class="dv">4</span>:<span class="dv">12</span>]</span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>    QS_tot_fNIR <span class="op">=</span> <span class="fl">0.5</span><span class="op">*</span>SurfaceArea<span class="op">@</span>climate[n, <span class="dv">12</span>:<span class="dv">20</span>] <span class="co"># Diffuse</span></span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>    QS_tot_fVIS <span class="op">=</span> <span class="fl">0.5</span><span class="op">*</span>SurfaceArea<span class="op">@</span>climate[n, <span class="dv">12</span>:<span class="dv">20</span>]</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transmitted solar radiation</span></span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>    QS_int_rNIR <span class="op">=</span> tau_c_NIR<span class="op">*</span>QS_tot_rNIR <span class="co"># J/s total inside greenhouse</span></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>    QS_int_rVIS <span class="op">=</span> tau_c_VIS<span class="op">*</span>QS_tot_rVIS</span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>    QS_int_fNIR <span class="op">=</span> tau_c_NIR<span class="op">*</span>QS_tot_fNIR</span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>    QS_int_fVIS <span class="op">=</span> tau_c_VIS<span class="op">*</span>QS_tot_fVIS </span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solar radiation absorbed by the cover and the obstructions</span></span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>    QS_c <span class="op">=</span> alph_c<span class="op">*</span>(QS_tot_rNIR <span class="op">+</span> QS_tot_rVIS <span class="op">+</span> QS_tot_fNIR <span class="op">+</span> QS_tot_fVIS) <span class="co"># J/s</span></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>    QS_i <span class="op">=</span> a_obs<span class="op">*</span>(QS_int_rNIR <span class="op">+</span> QS_int_rVIS <span class="op">+</span> QS_int_fNIR <span class="op">+</span> QS_int_fVIS) </span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solar radiation absorbed by the vegetation</span></span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Area = A_v i.e. planted area</span></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># factor QS by A_v/A_f</span></span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>    k_fNIR <span class="op">=</span> <span class="fl">0.27</span> <span class="co"># Near-IR diffuse extinction coefficient [-]</span></span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>    a_v_fNIR <span class="op">=</span> <span class="fl">0.65</span> <span class="op">-</span> <span class="fl">0.65</span><span class="op">*</span>np.exp(<span class="op">-</span>k_fNIR<span class="op">*</span>LAI) <span class="co"># Near-IR diffuse absorption coefficient [-]</span></span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>    k_fVIS <span class="op">=</span> <span class="fl">0.85</span> <span class="co"># Visible diffuse extinction coefficient [-]</span></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>    a_v_fVIS <span class="op">=</span> <span class="fl">0.95</span> <span class="op">-</span> <span class="fl">0.9</span><span class="op">*</span>np.exp(<span class="op">-</span>k_fVIS<span class="op">*</span>LAI) <span class="co"># Visible diffuse absorption coefficient [-]</span></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a>    k_rNIR <span class="op">=</span> <span class="fl">0.25</span> <span class="op">+</span> <span class="fl">0.38</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.12</span><span class="op">*</span>angle) <span class="co"># Near-IR direct extinction coefficient [-]</span></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>    a_v_rNIR <span class="op">=</span> <span class="fl">0.67</span> <span class="op">-</span> <span class="fl">0.06</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.08</span><span class="op">*</span>angle) <span class="op">-</span> (<span class="fl">0.68</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.11</span><span class="op">*</span>angle))<span class="op">*</span>np.exp(<span class="op">-</span>k_rNIR<span class="op">*</span>LAI) <span class="co"># Near-IR direct absorption coefficient [-]</span></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>    k_rVIS <span class="op">=</span> <span class="fl">0.88</span> <span class="op">+</span> <span class="fl">2.6</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.18</span><span class="op">*</span>angle) <span class="co"># Visible direct extinction coefficient [-]</span></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>    a_v_rVIS <span class="op">=</span> <span class="fl">0.94</span> <span class="op">-</span> <span class="fl">0.95</span><span class="op">*</span>np.exp(<span class="op">-</span>k_rVIS<span class="op">*</span>LAI) <span class="co"># Visible direct absorption coefficient [-]</span></span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>    QS_v_rNIR <span class="op">=</span> (QS_int_rNIR<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs) <span class="op">+</span> QS_al_NIR)<span class="op">*</span>a_v_rNIR<span class="op">*</span>A_v<span class="op">/</span>A_f</span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>    QS_v_fNIR <span class="op">=</span> (QS_int_fNIR<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs))<span class="op">*</span>a_v_fNIR<span class="op">*</span>A_v<span class="op">/</span>A_f</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>    QS_v_NIR <span class="op">=</span> (QS_v_rNIR <span class="op">+</span> QS_v_fNIR) <span class="co"># factor as planted area not entire floor</span></span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>    QS_v_rVIS <span class="op">=</span> (QS_int_rVIS<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs) <span class="op">+</span> QS_al_VIS)<span class="op">*</span>a_v_rVIS<span class="op">*</span>A_v<span class="op">/</span>A_f</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>    QS_v_fVIS <span class="op">=</span> (QS_int_fVIS<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs))<span class="op">*</span>a_v_fVIS<span class="op">*</span>A_v<span class="op">/</span>A_f</span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>    QS_v_VIS <span class="op">=</span> (QS_v_rVIS <span class="op">+</span> QS_v_fVIS) <span class="co"># Used for photosynthesis calc</span></span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solar radiation absorbed by the mat</span></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a>    a_m_fNIR <span class="op">=</span> <span class="fl">0.05</span> <span class="op">+</span> <span class="fl">0.91</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.5</span><span class="op">*</span>LAI) <span class="co"># Near-IR diffuse absorption coefficient [-]</span></span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>    a_m_fVIS <span class="op">=</span> np.exp(<span class="op">-</span><span class="fl">0.92</span><span class="op">*</span>LAI) <span class="co"># Visible diffuse absorption coefficient [-]</span></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>    a_m_rNIR <span class="op">=</span> <span class="fl">0.05</span> <span class="op">+</span> <span class="fl">0.06</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.08</span><span class="op">*</span>angle) <span class="op">+</span> (<span class="fl">0.92</span> <span class="op">-</span> <span class="fl">0.53</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.18</span><span class="op">*</span>angle))<span class="op">*</span>np.exp(<span class="op">-</span>(<span class="fl">0.48</span> <span class="op">+</span> <span class="fl">0.54</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.13</span><span class="op">*</span>angle))<span class="op">*</span>LAI) <span class="co"># Near-IR direct absorption coefficient [-]</span></span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>    a_m_rVIS <span class="op">=</span> np.exp(<span class="op">-</span>(<span class="fl">0.9</span> <span class="op">+</span> <span class="fl">0.83</span><span class="op">*</span>np.exp(<span class="op">-</span><span class="fl">0.12</span><span class="op">*</span>angle))<span class="op">*</span>LAI) <span class="co"># Visible direct absorption coefficient [-]</span></span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>    QS_m_rNIR <span class="op">=</span> (QS_int_rNIR<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs) <span class="op">+</span> QS_al_NIR)<span class="op">*</span>a_m_rNIR<span class="op">*</span>A_v<span class="op">/</span>A_f</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>    QS_m_fNIR <span class="op">=</span> QS_int_fNIR<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs)<span class="op">*</span>a_m_fNIR<span class="op">*</span>A_v<span class="op">/</span>A_f <span class="co"># W</span></span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>    QS_m_NIR <span class="op">=</span> (QS_m_rNIR <span class="op">+</span> QS_m_fNIR)</span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>    QS_m_rVIS <span class="op">=</span> (QS_int_rVIS<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs) <span class="op">+</span> QS_al_VIS)<span class="op">*</span>a_m_rVIS<span class="op">*</span>A_v<span class="op">/</span>A_f </span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a>    QS_m_fVIS <span class="op">=</span> QS_int_fVIS<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> a_obs)<span class="op">*</span>a_m_fVIS<span class="op">*</span>A_v<span class="op">/</span>A_f</span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a>    QS_m_VIS <span class="op">=</span> (QS_m_rVIS <span class="op">+</span> QS_m_fVIS)</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solar radiation absorbed by the floor</span></span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># factor by (A_f-A_v)/A_f</span></span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>    QS_s_rNIR <span class="op">=</span> QS_int_rNIR<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>a_obs)<span class="op">*</span>alphS_s<span class="op">*</span>(A_f<span class="op">-</span>A_v)<span class="op">/</span>A_f</span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>    QS_s_fNIR <span class="op">=</span> QS_int_fNIR<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>a_obs)<span class="op">*</span>alphS_s<span class="op">*</span>(A_f<span class="op">-</span>A_v)<span class="op">/</span>A_f</span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>    QS_s_NIR <span class="op">=</span> QS_s_rNIR <span class="op">+</span> QS_s_fNIR</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>    QS_s_rVIS <span class="op">=</span> QS_int_rVIS<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>a_obs)<span class="op">*</span>alphS_s<span class="op">*</span>(A_f<span class="op">-</span>A_v)<span class="op">/</span>A_f </span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>    QS_s_fVIS <span class="op">=</span> QS_int_fVIS<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>a_obs)<span class="op">*</span>alphS_s<span class="op">*</span>(A_f<span class="op">-</span>A_v)<span class="op">/</span>A_f</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>    QS_s_VIS <span class="op">=</span> QS_s_rVIS <span class="op">+</span> QS_s_fVIS</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Transpiration</span></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>    QS_int <span class="op">=</span> (QS_int_rNIR <span class="op">+</span> QS_int_rVIS <span class="op">+</span> QS_int_fNIR <span class="op">+</span> QS_int_fVIS)<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>a_obs)<span class="op">*</span>A_v<span class="op">/</span>A_f <span class="co"># J/s</span></span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  Vapour pressure deficit at leaf surface</span></span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>    xa <span class="op">=</span> C_w<span class="op">/</span>rho_i <span class="co">#[-]</span></span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>    xv <span class="op">=</span> sat_conc(T_v)<span class="op">/</span>rho_i <span class="co">#[-]</span></span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>    vpd <span class="op">=</span> atm<span class="op">*</span>(xv<span class="op">/</span>(xv <span class="op">+</span> <span class="fl">0.622</span>) <span class="op">-</span> xa<span class="op">/</span>(xa <span class="op">+</span> <span class="fl">0.622</span>)) <span class="co"># [Pa]</span></span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stomatal resistance according to Stanghellini</span></span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.exp(<span class="op">-</span><span class="fl">0.24</span><span class="op">*</span>LAI) <span class="co"># [-]</span></span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>    a_v_short <span class="op">=</span> <span class="fl">0.83</span><span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> <span class="fl">0.70</span><span class="op">*</span>x)<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.58</span><span class="op">*</span>x<span class="op">**</span><span class="dv">2</span>)<span class="op">*</span>(<span class="fl">0.88</span> <span class="op">-</span> x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="fl">0.12</span><span class="op">*</span>x<span class="op">**</span>(<span class="dv">8</span><span class="op">/</span><span class="dv">3</span>)) <span class="co"># [-]Absorption for shortwave radiation</span></span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>    I_s_bar <span class="op">=</span> QS_int<span class="op">*</span>a_v_short<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>LAI) <span class="co"># [J/s] Mean radiation interacting with leaf surface</span></span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>    Heavy_CO2 <span class="op">=</span> I_s_bar <span class="op">&gt;</span> <span class="fl">0.</span></span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>    r_i_CO2 <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> Heavy_CO2<span class="op">*</span><span class="fl">6.1e-7</span><span class="op">*</span>(C_c_ppm <span class="op">-</span> <span class="dv">200</span>)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>    Heavy_vpd <span class="op">=</span> vpd<span class="op">/</span><span class="dv">1000</span> <span class="op">&lt;</span> <span class="fl">0.8</span></span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>    r_i_vpd <span class="op">=</span> Heavy_vpd<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">4.3</span><span class="op">*</span>(vpd<span class="op">/</span><span class="dv">1000</span>)<span class="op">**</span><span class="dv">2</span>) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> Heavy_vpd)<span class="op">*</span><span class="fl">3.8</span></span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>    r_st <span class="op">=</span> <span class="dv">82</span><span class="op">*</span>((QS_int <span class="op">+</span> <span class="fl">4.3</span>)<span class="op">/</span>(QS_int <span class="op">+</span> <span class="fl">0.54</span>))<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.023</span><span class="op">*</span>(T_v <span class="op">-</span> T_k <span class="op">-</span> <span class="fl">24.5</span>)<span class="op">**</span><span class="dv">2</span>)<span class="op">*</span>r_i_CO2<span class="op">*</span>r_i_vpd <span class="co">#[s/m]</span></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>    hL_v_i <span class="op">=</span> <span class="dv">2</span><span class="op">*</span>LAI<span class="op">*</span>H_fg<span class="op">/</span>(rho_i<span class="op">*</span>c_i)<span class="op">*</span>(Le<span class="op">**</span>(<span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)<span class="op">/</span>HV <span class="op">+</span> r_st<span class="op">/</span>(rho_i<span class="op">*</span>c_i))<span class="op">**</span>(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>    QT_St <span class="op">=</span> A_v<span class="op">*</span>hL_v_i<span class="op">*</span>(sat_conc(T_v) <span class="op">-</span> C_w) <span class="co"># J/s</span></span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>    QT_v_i <span class="op">=</span> <span class="bu">max</span>(QT_St,<span class="dv">0</span>)</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Dehumidification</span></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>    MW_cc_i <span class="op">=</span> <span class="dv">0</span> <span class="co"># No dehumidification included</span></span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CO2 exchange with outside</span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>    MC_i_e <span class="op">=</span> (R_a<span class="op">*</span>(C_c <span class="op">-</span> C_ce)) <span class="co"># [kg/m^3/s]</span></span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>    day_hour_c<span class="op">=</span>(hour<span class="op">/</span><span class="dv">24</span><span class="op">-</span>np.floor(hour<span class="op">/</span><span class="dv">24</span>))<span class="op">*</span><span class="dv">24</span></span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>    track<span class="op">=</span>day_hour_c<span class="op">&gt;</span><span class="dv">6</span> <span class="kw">and</span> day_hour_c<span class="op">&lt;</span><span class="dv">20</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>    Value<span class="op">=</span>added_CO2<span class="op">/</span>Nz<span class="op">/</span><span class="fl">3600.</span><span class="op">/</span>V</span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>    MC_cc_i<span class="op">=</span>Value<span class="op">*</span>track</span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>    <span class="co">## PHOTOSYNTHESIS MODEL - VANTHOOR</span></span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Consider photosynthetically active radiation to be visible radiation</span></span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>    T_25 <span class="op">=</span> T_k <span class="op">+</span> <span class="fl">25.</span> <span class="co"># K</span></span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>    I_VIS<span class="op">=</span>QS_v_VIS <span class="co"># J/s incident on planted area</span></span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>    PAR <span class="op">=</span> I_VIS<span class="op">/</span>heat_phot<span class="op">/</span>N_A<span class="op">/</span>A_v </span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The number of moles of photosynthetically active photons per unit area of planted floor [mol{phot}/m^2/s]</span></span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>    <span class="co">#J/s/(J/photon)/(photons/mol)/m^2 cf Vanthoor 2.3mumol(photons)/J</span></span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>    Gamma <span class="op">=</span> <span class="bu">max</span>((c_Gamma<span class="op">*</span>(T_v <span class="op">-</span> T_k)<span class="op">/</span>LAI <span class="op">+</span> <span class="dv">20</span><span class="op">*</span>c_Gamma<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> <span class="dv">1</span><span class="op">/</span>LAI)),<span class="dv">0</span>) <span class="co"># The CO2 compensation point [mol{CO2}/mol{air}]</span></span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a>    k_switch <span class="op">=</span> C_buf_max <span class="co"># kg/m^2/s</span></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>    h_airbuf_buf <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> np.exp(s_airbuf_buf<span class="op">*</span>(C_buf <span class="op">-</span> k_switch)))</span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a>    C_c_molar<span class="op">=</span>(C_c<span class="op">/</span>rho_i)<span class="op">*</span>(M_a<span class="op">/</span>M_c)</span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a>    C_stom <span class="op">=</span> eta<span class="op">*</span>C_c_molar <span class="co"># Stomatal CO2 concentration [mol{CO2}/mol{air}] </span></span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>    J_pot <span class="op">=</span> LAI<span class="op">*</span>J_max_25<span class="op">*</span>np.exp(E_j<span class="op">*</span>(T_v <span class="op">-</span> T_25)<span class="op">/</span>(R<span class="op">*</span>T_v<span class="op">*</span>T_25))<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> np.exp((S<span class="op">*</span>T_25 <span class="op">-</span> HH)<span class="op">/</span>(R<span class="op">*</span>T_25)))<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> np.exp((S<span class="op">*</span>T_v <span class="op">-</span> HH)<span class="op">/</span>(R<span class="op">*</span>T_v))) <span class="co"># [mol{e}/m^2{floor}s]</span></span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>    J <span class="op">=</span> (J_pot <span class="op">+</span> alph<span class="op">*</span>PAR <span class="op">-</span> ((J_pot <span class="op">+</span> alph<span class="op">*</span>PAR)<span class="op">**</span><span class="dv">2</span> <span class="op">-</span> <span class="dv">4</span><span class="op">*</span>theta<span class="op">*</span>J_pot<span class="op">*</span>alph<span class="op">*</span>PAR)<span class="op">**</span><span class="fl">0.5</span>)<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>theta)</span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> J<span class="op">*</span>(C_stom <span class="op">-</span> Gamma)<span class="op">/</span>(<span class="dv">4</span><span class="op">*</span>(C_stom <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>Gamma)) <span class="co"># Photosynthesis rate [mol{CO2}/s]</span></span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>    Resp <span class="op">=</span> P<span class="op">*</span>Gamma<span class="op">/</span>C_stom <span class="co"># Photorespiration rate</span></span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>    MC_i_buf <span class="op">=</span> (M_carb<span class="op">*</span>h_airbuf_buf<span class="op">*</span>(P <span class="op">-</span> Resp)) <span class="co"># The net photosynthesis rate [kg{CH2O}/m^2/s]</span></span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MC_i_buf = 0</span></span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>    <span class="co">## CROP GROWTH MODEL</span></span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flow of carbohydrates from buffer to fruit, leaves and stem</span></span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>    C_buf_min <span class="op">=</span> <span class="fl">0.05</span><span class="op">*</span>C_buf_max</span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>    h_buforg_buf <span class="op">=</span><span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> np.exp(s_buforg_buf<span class="op">*</span>(C_buf <span class="op">-</span> C_buf_min)))</span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>    <span class="co"># inhibition terms need temperatures in oC</span></span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>    h_T_v <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> np.exp(s_min_T<span class="op">*</span>((T_v<span class="op">-</span>T_k) <span class="op">-</span> T_min_v)))<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> np.exp(s_max_T<span class="op">*</span>((T_v<span class="op">-</span>T_k) <span class="op">-</span> T_max_v))) </span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>    h_T_v24 <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> np.exp(s_min_T24<span class="op">*</span>((T_vmean<span class="op">-</span>T_k) <span class="op">-</span> T_min_v24)))<span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span> np.exp(s_max_T24<span class="op">*</span>((T_vmean<span class="op">-</span>T_k) <span class="op">-</span> T_max_v24))) </span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>    h_T_vsum <span class="op">=</span> <span class="fl">0.5</span><span class="op">*</span>(T_vsum<span class="op">/</span>T_sum_end <span class="op">+</span> ((T_vsum<span class="op">/</span>T_sum_end)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="fl">1e-4</span>)<span class="op">**</span><span class="fl">0.5</span>) <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span>(((T_vsum <span class="op">-</span> T_sum_end)<span class="op">/</span>T_sum_end)<span class="op">+</span>(((T_vsum <span class="op">-</span> T_sum_end)<span class="op">/</span>T_sum_end)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="fl">1e-4</span>)<span class="op">**</span><span class="fl">0.5</span>) </span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>    g_T_v24 <span class="op">=</span> <span class="fl">0.047</span><span class="op">*</span>(T_vmean <span class="op">-</span> T_k) <span class="op">+</span> <span class="fl">0.06</span></span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>    MC_buf_fruit <span class="op">=</span> (h_buforg_buf<span class="op">*</span>h_T_v<span class="op">*</span>h_T_v24<span class="op">*</span>h_T_vsum<span class="op">*</span>g_T_v24<span class="op">*</span>rg_fruit) </span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>    MC_buf_leaf <span class="op">=</span> (h_buforg_buf<span class="op">*</span>h_T_v24<span class="op">*</span>g_T_v24<span class="op">*</span>rg_leaf)</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>    MC_buf_stem <span class="op">=</span> (h_buforg_buf<span class="op">*</span>h_T_v24<span class="op">*</span>g_T_v24<span class="op">*</span>rg_stem)</span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Growth respiration, which is CO2 leaving the buffer</span></span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a>    MC_buf_i <span class="op">=</span> c_fruit_g<span class="op">*</span>MC_buf_fruit <span class="op">+</span> c_leaf_g<span class="op">*</span>MC_buf_leaf <span class="op">+</span> c_stem_g<span class="op">*</span>MC_buf_stem</span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MC_buf_i = 0</span></span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Maintenance respiration</span></span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>    MC_fruit_i <span class="op">=</span> (c_fruit_m<span class="op">*</span>Q_10<span class="op">**</span>(<span class="fl">0.1</span><span class="op">*</span>(T_vmean <span class="op">-</span> T_25))<span class="op">*</span>C_fruit<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>c_RGR<span class="op">*</span>R_fruit)))</span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>    MC_leaf_i <span class="op">=</span> (c_leaf_m<span class="op">*</span>Q_10<span class="op">**</span>(<span class="fl">0.1</span><span class="op">*</span>(T_vmean <span class="op">-</span> T_25))<span class="op">*</span>C_leaf<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>c_RGR<span class="op">*</span>R_leaf)))</span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a>    MC_stem_i <span class="op">=</span> (c_stem_m<span class="op">*</span>Q_10<span class="op">**</span>(<span class="fl">0.1</span><span class="op">*</span>(T_vmean <span class="op">-</span> T_25))<span class="op">*</span>C_stem<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span> np.exp(<span class="op">-</span>c_RGR<span class="op">*</span>R_stem)))</span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>    C_max_leaf <span class="op">=</span> LAI_max<span class="op">/</span>SLA</span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>    MC_leaf_prune <span class="op">=</span> <span class="bu">max</span>(C_leaf <span class="op">-</span> C_max_leaf, <span class="dv">0</span>)</span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MC_leaf_prune=0</span></span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>    <span class="co">## ODE equations</span></span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temperature components</span></span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>    dT_c_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(A_c<span class="op">*</span>cd_c))<span class="op">*</span>(QV_i_c <span class="op">+</span> QP_i_c <span class="op">-</span> QR_c_f <span class="op">-</span> QR_c_v <span class="op">-</span> QR_c_m <span class="op">+</span> QV_e_c <span class="op">-</span> QR_c_sk <span class="op">+</span> QS_c)</span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>    dT_i_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(V<span class="op">*</span>rho_i<span class="op">*</span>c_i))<span class="op">*</span>(<span class="op">-</span>QV_i_m <span class="op">-</span> QV_i_v <span class="op">-</span> QV_i_f <span class="op">-</span> QV_i_c <span class="op">-</span> QV_i_e <span class="op">-</span> QV_i_p <span class="op">+</span> QS_i)</span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>    dT_v_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(c_v<span class="op">*</span>A_v<span class="op">*</span>msd_v))<span class="op">*</span>(QV_i_v <span class="op">-</span> QR_v_c <span class="op">-</span> QR_v_m <span class="op">-</span> QR_v_p <span class="op">+</span> QS_v_NIR <span class="op">-</span> QT_v_i)</span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a>    dT_m_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(A_m<span class="op">*</span>c_m))<span class="op">*</span>(QV_i_m <span class="op">+</span> QP_i_m <span class="op">-</span> QR_m_v <span class="op">-</span> QR_m_c <span class="op">-</span> QR_m_p <span class="op">-</span> QD_m_p <span class="op">+</span> QS_m_NIR)</span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>    dT_p_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(A_p<span class="op">*</span>c_p))<span class="op">*</span>(QD_m_p <span class="op">+</span> QV_i_p <span class="op">+</span> QP_i_p <span class="op">-</span> QR_p_f <span class="op">-</span> QR_p_v <span class="op">-</span> QR_p_m)</span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>    dT_f_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(rhod_s[<span class="dv">0</span>]<span class="op">*</span>A_f<span class="op">*</span>c_s[<span class="dv">0</span>]<span class="op">*</span>l_s[<span class="dv">0</span>]))<span class="op">*</span>(QV_i_f <span class="op">+</span> QP_i_f <span class="op">-</span> QR_f_c <span class="op">-</span> QR_f_p <span class="op">-</span> QD_sf1 <span class="op">+</span> QS_s_NIR)</span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>    dT_s1_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(rhod_s[<span class="dv">1</span>]<span class="op">*</span>c_s[<span class="dv">1</span>]<span class="op">*</span>l_s[<span class="dv">1</span>]<span class="op">*</span>A_f))<span class="op">*</span>(QD_sf1<span class="op">-</span>QD_s12)</span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>    dT_s2_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(rhod_s[<span class="dv">2</span>]<span class="op">*</span>c_s[<span class="dv">2</span>]<span class="op">*</span>l_s[<span class="dv">2</span>]<span class="op">*</span>A_f))<span class="op">*</span>(QD_s12<span class="op">-</span>QD_s23)</span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a>    dT_s3_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(rhod_s[<span class="dv">3</span>]<span class="op">*</span>c_s[<span class="dv">3</span>]<span class="op">*</span>l_s[<span class="dv">3</span>]<span class="op">*</span>A_f))<span class="op">*</span>(QD_s23<span class="op">-</span>QD_s34)</span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a>    dT_s4_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(rhod_s[<span class="dv">4</span>]<span class="op">*</span>c_s[<span class="dv">4</span>]<span class="op">*</span>l_s[<span class="dv">4</span>]<span class="op">*</span>A_f))<span class="op">*</span>(QD_s34<span class="op">-</span>QD_s45)</span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Water vapour</span></span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>    dC_w_dt <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(V<span class="op">*</span>H_fg))<span class="op">*</span>(QT_v_i<span class="op">-</span>QP_i_c<span class="op">-</span>QP_i_f<span class="op">-</span>QP_i_m<span class="op">-</span>QP_i_p) <span class="op">-</span> MW_i_e <span class="op">+</span> MW_cc_i</span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>    <span class="co">#dC_wdt = -MW_i_e</span></span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Carbon Dioxide</span></span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>    dC_c_dt <span class="op">=</span> MC_cc_i <span class="op">-</span> MC_i_e <span class="op">+</span> (M_c<span class="op">/</span>M_carb)<span class="op">*</span>(A_v<span class="op">/</span>V)<span class="op">*</span>(MC_buf_i <span class="op">+</span> MC_fruit_i <span class="op">+</span> MC_leaf_i <span class="op">+</span> MC_stem_i <span class="op">-</span> MC_i_buf)</span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plant growth control</span></span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>    dT_vmean_dt <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">86400</span><span class="op">*</span>(T_v <span class="op">-</span> T_vmean) </span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>    dT_vsum_dt <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">86400</span><span class="op">*</span>(T_v <span class="op">-</span> T_k) </span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plant carbon exchange</span></span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a>    dC_buf_dt <span class="op">=</span> MC_i_buf <span class="op">-</span> MC_buf_fruit <span class="op">-</span> MC_buf_leaf <span class="op">-</span> MC_buf_stem <span class="op">-</span> MC_buf_i</span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a>    dC_fruit_dt <span class="op">=</span> MC_buf_fruit <span class="op">-</span> MC_fruit_i</span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>    dC_leaf_dt <span class="op">=</span> MC_buf_leaf <span class="op">-</span> MC_leaf_i <span class="op">-</span> MC_leaf_prune</span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>    dC_stem_dt <span class="op">=</span> MC_buf_stem <span class="op">-</span> MC_stem_i</span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plant growth</span></span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a>    dR_fruit_dt <span class="op">=</span> (dC_fruit_dt<span class="op">/</span>C_fruit <span class="op">-</span> R_fruit)</span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a>    dR_leaf_dt <span class="op">=</span> ((dC_leaf_dt <span class="op">+</span> MC_leaf_prune)<span class="op">/</span>C_leaf <span class="op">-</span> R_leaf)</span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a>    dR_stem_dt <span class="op">=</span> (dC_stem_dt<span class="op">/</span>C_stem <span class="op">-</span> R_stem)</span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array([dT_c_dt,dT_i_dt,dT_v_dt,dT_m_dt,dT_p_dt,dT_f_dt,dT_s1_dt,dT_s2_dt,dT_s3_dt,dT_s4_dt,dT_vmean_dt,dT_vsum_dt,dC_w_dt,dC_c_dt,dC_buf_dt,dC_fruit_dt,dC_leaf_dt,dC_stem_dt,dR_fruit_dt,dR_leaf_dt,dR_stem_dt])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="simulate-over-time" class="level2">
<h2 class="anchored" data-anchor-id="simulate-over-time">Simulate over time</h2>
<p>The model detailed above is run for 364 days to calculate the environmental conditions and crop growth in the greenhouse.</p>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>tic <span class="op">=</span> time.time()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sim_days <span class="op">=</span> <span class="dv">364</span> <span class="co"># Number of days of simulation</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>tf <span class="op">=</span> <span class="dv">86400</span><span class="op">*</span>sim_days <span class="co"># Time in seconds</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> [<span class="dv">0</span>,tf]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>tval <span class="op">=</span> np.linspace(<span class="dv">0</span>,tf,tf<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Use solve_ivp with 'BDF' stiff solver to solve the ODEs</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> solve_ivp(model, t, z, method<span class="op">=</span><span class="st">'BDF'</span>, t_eval<span class="op">=</span>tval, rtol <span class="op">=</span> <span class="fl">1e-5</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Time simulation and print time taken</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>toc <span class="op">=</span> time.time()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>xt <span class="op">=</span> toc<span class="op">-</span>tic</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Runtime(s) = '</span>, <span class="ss">f"</span><span class="sc">{</span>xt<span class="sc">:.3}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Runtime(s) =  53.6</code></pre>
</div>
</div>
</section>
<section id="plot-results" class="level2">
<h2 class="anchored" data-anchor-id="plot-results">Plot results</h2>
<p>Set up output data for plotting.</p>
<div class="cell" data-execution_count="6">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Tout_c <span class="op">=</span> np.transpose(output.y[<span class="dv">0</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>Tout_i <span class="op">=</span> np.transpose(output.y[<span class="dv">1</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>Tout_v <span class="op">=</span> np.transpose(output.y[<span class="dv">2</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>Tout_m <span class="op">=</span> np.transpose(output.y[<span class="dv">3</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>Tout_p <span class="op">=</span> np.transpose(output.y[<span class="dv">4</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>Tout_f <span class="op">=</span> np.transpose(output.y[<span class="dv">5</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>Tout_s1 <span class="op">=</span> np.transpose(output.y[<span class="dv">6</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>Tout_s2 <span class="op">=</span> np.transpose(output.y[<span class="dv">7</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>Tout_s3 <span class="op">=</span> np.transpose(output.y[<span class="dv">8</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>Tout_s4 <span class="op">=</span> np.transpose(output.y[<span class="dv">9</span>,:]<span class="op">-</span>T_k)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>Tvmeanout <span class="op">=</span> np.transpose(output.y[<span class="dv">10</span>,:])</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>Tvsumout <span class="op">=</span> np.transpose(output.y[<span class="dv">11</span>,:])</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>Cwout <span class="op">=</span> np.transpose(output.y[<span class="dv">12</span>,:])</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>Ccout <span class="op">=</span> np.transpose(output.y[<span class="dv">13</span>,:])</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>C_buf <span class="op">=</span> np.transpose(output.y[<span class="dv">14</span>,:])</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>C_fruit <span class="op">=</span> np.transpose(output.y[<span class="dv">15</span>,:])</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>C_leaf <span class="op">=</span> np.transpose(output.y[<span class="dv">16</span>,:])</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>C_stem <span class="op">=</span> np.transpose(output.y[<span class="dv">17</span>,:])</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>Rfruitout <span class="op">=</span> np.transpose(output.y[<span class="dv">18</span>,:])</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>Rleafout <span class="op">=</span> np.transpose(output.y[<span class="dv">19</span>,:])</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>Rstemout <span class="op">=</span> np.transpose(output.y[<span class="dv">20</span>,:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Temperatures</strong></p>
<p>The first three plots illustrate the temperature evolution in the greenhouse. Note how the mat gets quite warm before the plants have grown sufficiently to provide shade.</p>
<div class="cell" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>time <span class="op">=</span> output.t<span class="op">/</span>(<span class="dv">3600</span><span class="op">*</span><span class="dv">24</span>) <span class="co"># Time in days</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>ax.plot(time,Tout_i, color<span class="op">=</span><span class="st">'b'</span>, label <span class="op">=</span> <span class="st">'Internal air'</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>ax.plot(time,Tout_v, color<span class="op">=</span><span class="st">'g'</span>, linestyle <span class="op">=</span> <span class="st">':'</span>, label <span class="op">=</span> <span class="st">'Vegetation'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Internal air and vegetation temperatures'</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Day'</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Temperature ($^o$C)'</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="GES_Example_files/figure-html/cell-8-output-1.png" width="588" height="449"></p>
</div>
</div>
<div class="cell" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fig, ax2 <span class="op">=</span> plt.subplots()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ax2.plot(time,Tout_m, color<span class="op">=</span><span class="st">'brown'</span>, linestyle <span class="op">=</span> <span class="st">'-'</span>, label <span class="op">=</span> <span class="st">'Mat'</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>ax2.plot(time,Tout_p, color<span class="op">=</span><span class="st">'k'</span>, linestyle <span class="op">=</span> <span class="st">'--'</span>, label <span class="op">=</span> <span class="st">'Tray'</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ax2.plot(time,Tout_v, color<span class="op">=</span><span class="st">'g'</span>, linestyle <span class="op">=</span> <span class="st">':'</span>, label <span class="op">=</span> <span class="st">'Vegetation'</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Vegetation, mat and tray temperatures'</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Day'</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Temperature ($^o$C)'</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="GES_Example_files/figure-html/cell-9-output-1.png" width="588" height="449"></p>
</div>
</div>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ax1.plot(time,Tout_c, color<span class="op">=</span><span class="st">'b'</span>, label <span class="op">=</span> <span class="st">'Cover'</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>ax1.plot(time,Tout_f, color<span class="op">=</span><span class="st">'g'</span>, linestyle <span class="op">=</span> <span class="st">'--'</span>, label <span class="op">=</span> <span class="st">'Floor'</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ax1.plot(time,Tout_s1, color<span class="op">=</span><span class="st">'brown'</span>, linestyle <span class="op">=</span> <span class="st">':'</span>, label <span class="op">=</span> <span class="st">'Soil layer 1'</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ax1.plot(time,Tout_s4,color<span class="op">=</span><span class="st">'k'</span>,linestyle<span class="op">=</span><span class="st">'-.'</span>, label <span class="op">=</span> <span class="st">'Soil layer 4'</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Cover and floor temperatures'</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Day'</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Temperature ($^o$C)'</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="GES_Example_files/figure-html/cell-10-output-1.png" width="599" height="449"></p>
</div>
</div>
<p><strong>LAI</strong></p>
<p>The Leaf Area Index (LAI) shown below is the ratio of leaf area to surface area of the growing medium. Note that the maximum LAI is set to a value of 5. Once this value is reached it is assumed that leaves are removed to maintain the LAI at a constant value.</p>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fig, ax3 <span class="op">=</span> plt.subplots()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>LAI <span class="op">=</span> C_leaf <span class="op">*</span> SLA</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ax3.plot(time,LAI, color<span class="op">=</span><span class="st">'g'</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Leaf Area Index'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'Day'</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'LAI'</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="GES_Example_files/figure-html/cell-11-output-1.png" width="576" height="449"></p>
</div>
</div>
<p><strong>Relative Humidity</strong></p>
<p>Once the plants reach maximum LAI the relative humidity stays consistently high during the day due to transpiration.</p>
<div class="cell" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>RHout <span class="op">=</span> <span class="dv">100</span><span class="op">*</span>Cwout<span class="op">/</span>sat_conc(Tout_i<span class="op">+</span>T_k)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>fig, ax5 <span class="op">=</span> plt.subplots()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>ax5.plot(time,RHout, color<span class="op">=</span><span class="st">'b'</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>ax5.set_title(<span class="st">'Relative Humidity'</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>ax5.set_xlabel(<span class="st">'Day'</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>ax5.set_ylabel(<span class="st">'Relativce Humidity (%)'</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="GES_Example_files/figure-html/cell-12-output-1.png" width="593" height="449"></p>
</div>
</div>
<p><strong>CO<span class="math inline">\(_2\)</span></strong></p>
<p>Once the plants start to grow, CO<span class="math inline">\(_2\)</span> uptake is substantial. It is assumed that no supplemental CO<span class="math inline">\(_2\)</span> is provided, with the level inside the greenhouse being replenished via air exchange through the ventilation system. In this example the ventilation rate is dependent on temperature with vents opening when the temperature reaches 25<span class="math inline">\(^o\)</span>C and ventilation rate reaching a maximum 30ACH at 29<span class="math inline">\(^o\)</span>C.</p>
<div class="cell" data-execution_count="12">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Ccout_ppm <span class="op">=</span> Ccout<span class="op">*</span>R<span class="op">*</span>(Tout_i<span class="op">+</span>T_k)<span class="op">/</span>(M_c<span class="op">*</span>atm)<span class="op">*</span><span class="fl">1.e6</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>fig, ax4 <span class="op">=</span> plt.subplots()</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ax4.plot(time,Ccout_ppm, color<span class="op">=</span><span class="st">'b'</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'CO$_2$'</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">'Day'</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">'CO$_2$ (ppm)'</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="GES_Example_files/figure-html/cell-13-output-1.png" width="595" height="450"></p>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>